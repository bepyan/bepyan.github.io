---
title: 'Next.js mdx plugin'
description: '`next-mdx-remote`에서 플로그인으로 이쁜 결과물을 만들자.'
tags:
  - next.js
  - blog
draft: false
---

✨ [**next-mdx-remote**](https://github.com/hashicorp/next-mdx-remote)를 활용하여 markdown파일을 이쁜 HTML 코드로 변환해줍니다.   
markdown과 Custom React Component를 연결해주는 것이 특징입니다.

# 기본 사용법

```shell
yarn add next-mdx-remote
```

<br />

1. mdx 파일을 `serialize`하여 필요한 데이터를 추출하고 가공합니다.

```ts:libs/mdx.ts
import { serialize } from 'next-mdx-remote/serialize';

export const serializeMdx = (source: string) => {
  return serialize(source, {
    parseFrontmatter: false,
    mdxOptions: {
      remarkPlugins: [],
      rehypePlugins: [],
      format: 'mdx',
    },
  });
};
```

- [`remark plugins`](https://github.com/remarkjs/remark/blob/main/doc/plugins.md)과 [`rehype plugins`](https://github.com/rehypejs/rehype/blob/main/doc/plugins.md)를 활용해서 다양한 기능을 추가할 수 있습니다.

<br />

2. `getStaticProps`(빌드시점)에서 필요한 데이터를 모두 가공합니다.

```ts:[...slugs].tsx {21}
import { GetStaticPaths, GetStaticProps } from 'next';
import { serializeMdx } from '~/libs/mdx';
import { getAllPosts } from '~/libs/post';

export const getStaticPaths: GetStaticPaths = () => {
  const posts = getAllPosts();

  return {
    paths: posts.map((post) => `/blog/${post.slug}`),
    fallback: 'blocking',
  };
};

export const getStaticProps: GetStaticProps = async ({ params }) => {
  const { slugs } = params as { slugs: string[] };

  const slug = [...slugs].join('/');
  const post = getAllPosts().find((v) => v.slug === slug);
  //...

  const mdx = await serializeMdx(post.content);

  return {
    props: { mdx },
  };
};
```

3. 브라우저는 `<MDXRemote />`를 활용하여 데이터를 HTML로 변환합니다.

```tsx
export default function PostPage({ mdx }: { mdx: MDXRemoteSerializeResult }) {
  return (
    <div className="prose mt-4 w-full max-w-none dark:prose-dark">
      <MDXRemote {...mdx} />
    </div>
  );
}
```

# 필수 플러그인

모두 `server-side`에서 사용하게 될 것이기에 모두 `devDependency`로 설치해줍니다.

```shell
yarn add -D remark-gfm remark-toc rehype-prism-plus
yarn add -D @tailwindcss/typography
```

---

### remark-gfm

https://github.com/remarkjs/remark-gfm

`GFM`(autolink literals, footnotes, strikethrough, tables, tasklists...) 문법들을 해석해주는 도구 입니다.

---

### remark-toc

https://github.com/remarkjs/remark-toc

`Tabel of Content` 목차를 만들어 주는 도구 입니다.   
다른 포스트에서 집중적으로 활용해보도록 합시다.

---

### rehype-prism-plus

https://github.com/timlrx/rehype-prism-plus

[`prism`](https://prismjs.com/) 기반으로 코드블럭을 `syntax highlighting`해주는 도구 입니다.   
highlighting, showLineNumbers, line inserted, line deleted 등 기능도 제공해줍니다.   

```diff-js {1} showLineNumbers
function fancyAlert(arg) {
  if (arg) {
+    $.facebox({ div: '#foo' })
-    alert('#roo')
  }
}
```

하지만 코드 토큰만 해석해줄 뿐이지 스타일은 직접 씌워줘야합니다.   
prism기반의 [다양한 테마](https://github.com/PrismJS/prism-themes)를 적용할 수 있으니 취향 것 선택하면 됩니다.   
저는 [dracular](https://draculatheme.com/prism)에서 받아왔습니다.

자세한 설정은 [제 레포지토리](https://github.com/bepyan/bepyan.github.io/blob/main/src/styles/code.css)를 참고해주시면 될 것 같습니다. ~~생각보다 복잡합니다...~~

---

### @tailwindcss/typography

https://tailwindcss.com/docs/typography-plugin

tailwind 기반으로 mdx 마크업을 스타일링합니다.   
쉽게 [커스터마이징](https://tailwindcss.com/docs/typography-plugin#customizing-the-css)을 할 수 있습니다.

---

# 추천 플로그인

```shell
yarn add -D rehype-slug rehype-autolink-headings rehype-code-titles
```

### remark-math

https://github.com/remarkjs/remark-math

---

### reading-time

https://github.com/ngryman/reading-time

---

### rehype-slug + rehype-autolink-headings

https://github.com/rehypejs/rehype-slug

headings에 id를 심어준다.
이전에 많이 사용되었던 remark-slug는 deprecated 되었다.

- rehype-autolink-headings
  https://github.com/rehypejs/rehype-autolink-headings

`span.icon.icon-link`을 활용하여 anchor를 만들 수 있다.

```css
h2 > a > span.icon.icon-link {
  width: 18px;
  height: 18px;
}

h3 > a > span.icon.icon-link {
  width: 15px;
  height: 15px;
}

h4 > a > span.icon.icon-link {
  width: 12px;
  height: 12px;
}

span.icon.icon-link {
  display: inline-block;
  width: 15px;
  height: 15px;
  margin-right: 2px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 490 490' style='enable-background:new 0 0 490 490;' xml:space='preserve'%3E%3Cpath d='M64.333 490h58.401l33.878-137.69h122.259L245.39 490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04v-48.162H390.23L424.108 0H365.31l-33.878 138.661H208.79L242.668 0h-58.415l-33.864 138.661H32.411v48.162h106.298l-28.818 117.324h-77.48v48.162h65.8L64.333 490zM197.11 186.824h122.642l-29.2 117.324h-122.26l28.818-117.324z'/%3E%3C/svg%3E");
}

.dark span.icon.icon-link {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 490 490' style='enable-background:new 0 0 490 490; fill:white;' xml:space='preserve'%3E%3Cpath d='M64.333 490h58.401l33.878-137.69h122.259L245.39 490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04v-48.162H390.23L424.108 0H365.31l-33.878 138.661H208.79L242.668 0h-58.415l-33.864 138.661H32.411v48.162h106.298l-28.818 117.324h-77.48v48.162h65.8L64.333 490zM197.11 186.824h122.642l-29.2 117.324h-122.26l28.818-117.324z'/%3E%3C/svg%3E");
}
```

---

# 최종 코드

```ts:libs/mdx.ts
import { serialize } from 'next-mdx-remote/serialize';
import rehypeAutolinkHeadings from 'rehype-autolink-headings';
import rehypeCodeTitles from 'rehype-code-titles';
import rehypePrism from 'rehype-prism-plus';
import rehypeSlug from 'rehype-slug';
import remarkGfm from 'remark-gfm';
import remarkToc from 'remark-toc';

export const serializeMdx = (source: string) => {
  return serialize(source, {
    parseFrontmatter: true,
    mdxOptions: {
      remarkPlugins: [remarkToc, remarkGfm],
      rehypePlugins: [
        rehypeSlug,
        rehypeCodeTitles,
        rehypePrism,
        [
          rehypeAutolinkHeadings,
          {
            properties: {
              className: ['anchor'],
            },
          },
        ],
      ],
      format: 'mdx',
    },
  });
};
```

## 참고

https://yceffort.kr/2020/10/migrate-gatsby-from-nextjs  
https://colinhemphill.com/blog/fast-static-syntax-highlighting-for-mdx-in-nextjs

Project Level Snippets  
https://code.visualstudio.com/updates/v1_28#_project-level-snippets
